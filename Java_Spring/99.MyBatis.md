# [Spring] MyBatis 사용하기



## 개요

마이바티스는 개발자가 지정한 SQL, 저장프로시저 그리고 몇가지 고급 매핑을 지원하는 퍼시스턴스 프레임워크이다. 마이바티스는 JDBC로 처리하는 상당부분의 코드와 파라미터 설정및 결과 매핑을 대신해준다. 마이바티스는 데이터베이스 레코드에 원시타입과 Map 인터페이스 그리고 자바 POJO 를 설정해서 매핑하기 위해 XML과 애노테이션을 사용할 수 있다.

데이터의 저장, 조회, 변경, 삭제를 다루는 클래스 및 설정 파일들의 집합

https://mybatis.org/mybatis-3/ko/index.html





MyBatis의 핵심은 개발과 유지보수가 쉽도록 소스 코드에 내장돼있는 SQL을 별도의 파일로 분리하는 것이다. 또한 단순하고 반복적인 JDBC 코드를 캡슐화하여 데이터베이스 프로그래밍을 간결하게 만든다.

https://atoz-develop.tistory.com/entry/JAVAWEB-%EC%9B%B9-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8%EC%97%90-MyBatis-%EC%84%B8%ED%8C%85-%EB%B0%8F-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0



## 환경설정



의존성 추가

src/resources 디렉토리에 mybatis-config.xml 파일 생성.

src/resources/config/database.properties (File)

/WEB-INF/spring/datasource.xml (Spring Bean Configuration File)

mapper (sql 들어있는 파일)

https://jwkim96.tistory.com/62





## MyBatis로 database에 sql 날리기























준비 내역



entity

- getter, setter (@Data)

xml

yml

- mybatis
- datasource

dao





Registering many MyBatis XML files does not impose the same type of performance overhead as creating many prepared statements, but it can have an impact on the performance and maintenance of your application in other ways.

When you register a MyBatis XML file, the framework will parse the file and generate the corresponding SQL statements and mappings. This parsing and generation process can take some time and consume some resources, especially if you have many XML files.

However, the impact of registering many MyBatis XML files is generally not as significant as the impact of creating many prepared statements, as the parsing and generation process only happens once per file, typically at application startup time.

The main impact of registering many MyBatis XML files is on the maintenance of your application. When you have many XML files, it can become more difficult to manage and maintain your SQL statements and mappings, especially if they are spread across multiple files.

To mitigate this impact, you should aim to organize your MyBatis XML files in a logical and manageable way. For example, you could group related SQL statements and mappings into separate files, or use a naming convention that makes it easy to identify and locate specific files.

In summary, registering many MyBatis XML files can have an impact on the performance and maintenance of your application, but the impact is generally not as significant as the impact of creating many prepared statements. The key is to organize your XML files in a way that makes them easy to manage and maintain over time.







yml 파일

```yaml
wafful:
	mybatis:
		enabled: true
		config-location: sql/configuration.xml
		mapper-location: classpath:/sql/**/sql-*.xml
		type-aliases-package: com.ooo.ooo.ooo
```



configuration.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd" >
<configuration>
    
    <settings>
    	<setting name="cacheEnabled" value="true"/>
        <setting name="lazyLoadingEnabled" value="true"/>
        <setting name="multipleResultSetsEnabled" value="true"/>
        <setting name="mapUnderscoreToCamelCase" value="true"/>
        <setting name="callSettersOnNulls" value="true"/>
        <setting name="jdbcTypeForNull" value="NULL"/>
        <setting name="logImpl" value="SLF4J"/>
        <setting name="defaultExecutorType" value="REUSE"/>
    </settings>
    
    <typeAliases>
    	<typeAlias alias="LowerCamleCaseMap" type = "com.ooo.ooo.ooo.map.LowerCamelCaseMap"/>
        <package name = "ooo.ooo.ooo.online"></package>
    </typeAliases>
    <typeHandlers>
    	<typeHandler handler="org.apache.ibatis.type.ClobTypeHandler" jdbcType="CLOB" javaType="java.lang.String"/>
    </typeHandlers>
    
    
    
    <!--여기 아래부터는 블로그글-->
	<!--mapper에서 매칭할 parmeter Type 별칭 설정-->
	<typeAliases>
		<typeAlias type="kr.or.iei.student.model.vo.Student" alias="student"/>
	</typeAliases>

	<environments default="development">
		<!-- environment id를 구분하여 연결할 DB를 여려개 구성할 수 도 있음 -->
		<environment id="development">
			<transactionManager type="JDBC"/>
				<dataSource type="POOLED">
					<property name="driver" value="oracle.jdbc.driver.OracleDriver"/>
					<property name="url" value="jdbc:oracle:thin:@localhost:1521:xe"/>
					<property name="username" value="mybatis"/>
					<property name="password" value="mybatis"/>
				</dataSource>
		</environment>
	</environments>
	
	<mappers>
		<mapper resource="/student/student-mapper.xml"/> 
	</mappers>
	
	
</configuration>
```

| 설정                      | 설명                                                         | 가능한값들                             | 기본값 |
| ------------------------- | ------------------------------------------------------------ | -------------------------------------- | ------ |
| cacheEnabled              | 설정에서 각 매퍼에 설정된 캐시를 전역적으로 사용할지 말지에 대한 여부 | true/false                             | true   |
| lazyLoadingEnabled        | 지연로딩을 사용할지에 대한 여부                              | true/false                             | false  |
| multipleResultSetsEnabled | 한 개의 구문에서 여러 개의 ResultSet을 허용할지의 여부<br />:bulb: `;`으로 구분된 여러 개의 SELECT문 한번에 실행 시 반환 | true/false                             | true   |
| mapUnderscoreToCamelCase  | 전통적인 데이터베이스 칼럼명 형태인 A_COLUMN을 CamelCase형태의 자바 프로퍼티명 형태인 aColumn으로 자동으로 매핑하도록 함 | true/false                             | False  |
| callSettersOnNulls        | 가져온 값이 null일 때 setter나 맵의 put 메소드를 호출할지를 명시 Map.keySet() 이나 null값을 초기화할때 유용하다 | true/false                             | false  |
| jdbcTypeForNull           | JDBC타입을 파라미터에 제공하지 않을때 null값을 처리한 JDBC타입을 명시 | JdbcType 이늄(NULL, VARCHAR, OTHER 등) | OTHER  |
| logImpl                   | 마이바티스가 사용할 로깅 구현체를 명시<br />(미설정 시, 마이바티스가 사용할 로깅 구현체를 자동으로 찾는다.) | SLF4J, LOG4J2 , 등                     |        |
| defaultExecutorType       | - SIMPLE : 특별히 하는 것이 없음<br />- REUSE : PreparedStatement를 재사용. 반복 사용 시 유리<br />- BATCH : 하나의 배치에서 여러 개의 쿼리 실행 시 유리 | SIMPLE, REUSE, BATCH                   | SIMPLE |



:bulb: jdbcTypeForNull

Mybatis가 sql을 수행할 때 값을 정확하게 넣기 위해서는 파라미터의 JDBC type을 알고 있어야 함. 파라미터에 `null`이 들어왔을 때, JDBC type을 무엇으로 설정할 지에 대한 명시. value를 null로 지정 시, JDBC의 `Types.NULL` 사용함. 

하지만, 보통의 경우 JDBC driver가 자동으로 잘 지정하기에 특별한 경우를 제외하곤 꼭 지정할 필욘 없음



```xml
<typeAliases>
    <typeAlias alias="LowerCamleCaseMap" type = "com.ooo.ooo.ooo.map.LowerCamelCaseMap"/>
    <package name = "ooo.ooo.ooo.online"></package>
</typeAliases>
```

타입 별칭으로, mapper xml 파일에서 타이핑을 줄이기 위해서 사용된다.

`<typeAlias alias="Author" type="domain.blog.Author"/>` 로 개별 Entity에 대해서 타입 별칭을 지정해도 되며,

`<package name = "ooo.ooo.ooo.online"></package>` 로 패키지로 지정하면, 해당 패키지 내의 엔티티들은 패키지를 생략하고 명시 가능



```xml
<typeHandlers>
    <typeHandler handler="org.apache.ibatis.type.ClobTypeHandler" jdbcType="CLOB" javaType="java.lang.String"/>
</typeHandlers>
```

Java Type과 JDBC Type간 상호 변환을 정의. default typeHandler가 존재하며, custum으로 생성해서 명시 가능



environments

**중요하게 기억해야 할 것은 다중 환경을 설정할 수는 있지만 SqlSessionFactory 인스턴스마다 한 개만 사용할 수 있다는 것이다.**

두 개의 데이터베이스에 연결하고 싶다면 SqlSessionFactory 인스턴스를 두 개 만들 필요가 있다. 세 개의 데이터베이스를 사용한다면 역시 세 개의 인스턴스를 필요로 한다. 기억하기 쉽게







mapper

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mybatis">
  
  <select id="retrieveDepartment"
          resultType=""
          parameterType = "">
  	SELECT * FORM DEPARTMENT
  </select>
  
  
  <insert id="studentInsertValue" parameterType="student">
  	INSERT INTO STUDENT VALUES(student_seq.nextval, #{studentName},#{studentTel},#{studentEmail},#{studentAddr},default)
  </insert>
  
  
</mapper>
```



DAO 설정하기

```java
@Configuration
@MapperScan("com.yourpackage.dao")  // Specify the package where your DAO interfaces are located
public class MyBatisConfig {

    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
        factoryBean.setDataSource(dataSource);
        factoryBean.setConfigLocation(new PathMatchingResourcePatternResolver().getResource("classpath:mybatis-config.xml"));
        return factoryBean.getObject();
    }
}
```







