







`npm install fs-extra`	



```
sudo add-apt-repository ppa:ethereum/ethereum
sudo apt-get update
sudo apt-get install solc
```



besu 24.1.1

`npm install solc@0.8.19`

- :bulb: solidity 실행 파일과  compiler 버전이 맞아야 한다. (`npm show vue-router version`로 확인)
- besu 버전이랑도 맞아야 함



solidity,Solidity 컴파일러 설치하기,https://solidity-kr.readthedocs.io/ko/latest/installing-solidity.html









Storage.sol

```
// SPDX-License-Identifier: GPL-3.0

pragma solidity >=0.8.2 <0.9.0;

/**
 * @title Storage
 * @dev Store & retrieve value in a variable
 * @custom:dev-run-script ./scripts/deploy_with_ethers.ts
 */
contract Storage {

    uint256 number;

    /**
     * @dev Store value in variable
     * @param num value to store
     */
    function store(uint256 num) public {
        number = num;
    }

    /**
     * @dev Return value 
     * @return value of 'number'
     */
    function retrieve() public view returns (uint256){
        return number;
    }
}
```



compile.js

```
const fs = require("fs").promises;
const solc = require("solc");

async function main() {
  // Load the contract source code
  const sourceCode = await fs.readFile("Storage.sol", "utf8");
  // Compile the source code and retrieve the ABI and bytecode
  const { abi, bytecode } = compile(sourceCode, "Storage");
  // Store the ABI and bytecode into a JSON file
  const artifact = JSON.stringify({ abi, bytecode }, null, 2);
  await fs.writeFile("Storage.json", artifact);
}

function compile(sourceCode, contractName) {
  // Create the Solidity Compiler Standard Input and Output JSON
  const input = {
    language: "Solidity",
    sources: { main: { content: sourceCode } },
    settings: { outputSelection: { "*": { "*": ["abi", "evm.bytecode"] } } },
  };
  // Parse the compiler output to retrieve the ABI and bytecode
  const output = solc.compile(JSON.stringify(input));
  const artifact = JSON.parse(output).contracts.main[contractName];
  return {
    abi: artifact.abi,
    bytecode: artifact.evm.bytecode.object,
  };
}

main().then(() => process.exit(0));
```







contract_create.js

```
const path = require('path');
const fs = require('fs-extra');
const {Web3}  = require('web3');

// member1 details
const { tessera, besu, accounts } = require("./keys.js");
const { log } = require('console');
const host = besu.member1.url;
const accountAddress = besu.member1.accountAddress;

// abi and bytecode generated from simplestorage.sol:
// > solcjs --bin --abi simplestorage.sol
const contractJsonPath = path.resolve(__dirname,'Storage.json');
// console.log(contractJsonPath)
const contractJson = JSON.parse(fs.readFileSync(contractJsonPath));
// console.log(contractJson.abi[0].inputs)
const contractAbi = contractJson.abi;
const contractBytecode = contractJson.bytecode //.object


async function createContract(host) {
  const web3 = new Web3(host);
  // make an account and sign the transaction with the account's private key; you can alternatively use an exsiting account
  const account = accounts.account1 //web3.eth.accounts.create();
  // initialize the default constructor with a value `47 = 0x2F`; this value is appended to the bytecode
  // const contractConstructorInit = web3.eth.abi.encodeParameters(['uint256'], [47]).slice(2);
  // const contractConstructorInit = web3.eth.abi.encodeParameters(['uint'], ['47']).slice(2);
  log("contractBytecode ",contractBytecode)
  // log("contractConstructorInit ",contractConstructorInit)


  const txn = {
    chainId: 1981,
    nonce: await web3.eth.getTransactionCount(account.address),       // 0x00 because this is a new account
    from: account.address,
    to: null, //besu.member1.accountAddress,            //public tx
    value: null,
    data: '0x'+contractBytecode,
    gasPrice: "0x0",     //ETH per unit of gas
    gas: "0x2CA51"  //max number of gas units the tx is allowed to use
  };

  console.log("create and sign the txn")
  console.log(txn)
  const signedTx = await web3.eth.accounts.signTransaction(txn, account.privateKey);
  console.log("sending the txn")
  const txReceipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
  // const txReceipt = await web3.eth.sendRawTransaction(txn);
  console.log("txReceipt ", txReceipt)
  // console.log("tx transactionHash: " + txReceipt.transactionHash);
  // // txReceipt.contractAddress = txReceipt.from
  // console.log("tx contractAddress: " + txReceipt.contractAddress); // contractAddress
  return txReceipt;
};

async function main(){
  createContract(host)

}

if (require.main === module) {
  main();
}

module.exports = exports = main

```



